<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docx Comment Editor</title>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Docx Comment Editor</h1>
            <div id="upload-section">
                <div class="upload-area" id="uploadArea">
                    <p>Drop a .docx file here or click to select</p>
                    <input type="file" id="fileInput" accept=".docx" class="file-input">
                    <button id="uploadBtn" class="btn">Upload Document</button>
                </div>
            </div>
            <div id="status" class="status hidden"></div>
        </div>
        
        <div class="main-content">
            <div class="document-panel">
                <div id="document-content">
                    <div class="loading">Upload a document to start editing</div>
                </div>
            </div>
            
            <div class="comments-panel">
                <h3>Comments</h3>
                <div class="comments-list" id="commentsList">
                    <div class="loading">No comments yet</div>
                </div>
                
                <div class="add-comment-form" id="addCommentForm" style="display: none;">
                    <h4>Add Comment</h4>
                    <div class="form-group">
                        <label for="paragraphSelect">Select Paragraph:</label>
                        <select id="paragraphSelect" class="form-control">
                            <option value="">Select a paragraph...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="authorInput">Author:</label>
                        <input type="text" id="authorInput" class="form-control" placeholder="Your name" value="Anonymous">
                    </div>
                    <div class="form-group">
                        <label for="commentInput">Comment:</label>
                        <textarea id="commentInput" class="form-control" rows="3" placeholder="Enter your comment..."></textarea>
                    </div>
                    <button id="saveCommentBtn" class="btn">Save Comment</button>
                </div>
                
                <div id="export-section" style="display: none; margin-top: 20px;">
                    <button id="exportBtn" class="btn">Export Updated Document</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class DocxCommentEditor {
            constructor() {
                this.currentDocumentId = null;
                this.paragraphs = [];
                this.comments = [];
                this.selectedParagraphId = null;
                
                this.initEventListeners();
            }
            
            initEventListeners() {
                // File upload
                const fileInput = document.getElementById('fileInput');
                const uploadBtn = document.getElementById('uploadBtn');
                const uploadArea = document.getElementById('uploadArea');
                
                fileInput.addEventListener('change', () => this.handleFileSelect());
                uploadBtn.addEventListener('click', () => fileInput.click());
                
                // Drag and drop
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        this.handleFileSelect();
                    }
                });
                
                // Add comment
                document.getElementById('saveCommentBtn').addEventListener('click', () => this.addComment());
                
                // Export
                document.getElementById('exportBtn').addEventListener('click', () => this.exportDocument());
            }
            
            async handleFileSelect() {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                
                if (!file) return;
                
                if (!file.name.endsWith('.docx')) {
                    this.showStatus('Please select a .docx file', 'error');
                    return;
                }
                
                this.showStatus('Uploading document...', 'success');
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/api/upload/', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('Upload failed');
                    }
                    
                    const data = await response.json();
                    this.currentDocumentId = data.document_id;
                    this.paragraphs = data.paragraphs;
                    this.comments = data.comments;
                    
                    this.renderDocument();
                    this.renderComments();
                    this.showCommentForm();
                    this.showExportButton();
                    
                    this.showStatus('Document uploaded successfully!', 'success');
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    this.showStatus('Error uploading document', 'error');
                }
            }
            
            renderDocument() {
                const container = document.getElementById('document-content');
                container.innerHTML = '';
                
                this.paragraphs.forEach(para => {
                    const paraElement = document.createElement('div');
                    paraElement.className = 'paragraph';
                    paraElement.textContent = para.text;
                    paraElement.dataset.paragraphId = para.id;
                    
                    paraElement.addEventListener('click', () => {
                        // Remove previous selections
                        document.querySelectorAll('.paragraph.selected').forEach(el => {
                            el.classList.remove('selected');
                        });
                        
                        // Select this paragraph
                        paraElement.classList.add('selected');
                        this.selectedParagraphId = para.id;
                        
                        // Update dropdown
                        document.getElementById('paragraphSelect').value = para.id;
                    });
                    
                    container.appendChild(paraElement);
                });
                
                // Populate paragraph dropdown
                const select = document.getElementById('paragraphSelect');
                select.innerHTML = '<option value="">Select a paragraph...</option>';
                
                this.paragraphs.forEach(para => {
                    const option = document.createElement('option');
                    option.value = para.id;
                    option.textContent = `${para.id}. ${para.text.substring(0, 50)}${para.text.length > 50 ? '...' : ''}`;
                    select.appendChild(option);
                });
                
                select.addEventListener('change', () => {
                    const paragraphId = parseInt(select.value);
                    if (paragraphId) {
                        this.highlightParagraph(paragraphId);
                        this.selectedParagraphId = paragraphId;
                    }
                });
            }
            
            renderComments() {
                const container = document.getElementById('commentsList');
                
                if (this.comments.length === 0) {
                    container.innerHTML = '<div class="loading">No comments yet</div>';
                    return;
                }
                
                container.innerHTML = '';
                
                this.comments.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.className = 'comment';
                    commentElement.innerHTML = `
                        <div class="comment-author">${comment.author}</div>
                        <div class="comment-text">${comment.text}</div>
                    `;
                    
                    commentElement.addEventListener('click', () => {
                        this.highlightParagraph(comment.paragraph_id);
                    });
                    
                    container.appendChild(commentElement);
                });
            }
            
            highlightParagraph(paragraphId) {
                // Remove previous highlights
                document.querySelectorAll('.paragraph.highlighted').forEach(el => {
                    el.classList.remove('highlighted');
                });
                
                // Highlight target paragraph
                const paraElement = document.querySelector(`[data-paragraph-id="${paragraphId}"]`);
                if (paraElement) {
                    paraElement.classList.add('highlighted');
                    paraElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Remove highlight after 3 seconds
                    setTimeout(() => {
                        paraElement.classList.remove('highlighted');
                    }, 3000);
                }
            }
            
            async addComment() {
                const paragraphId = this.selectedParagraphId || document.getElementById('paragraphSelect').value;
                const author = document.getElementById('authorInput').value.trim() || 'Anonymous';
                const text = document.getElementById('commentInput').value.trim();
                
                if (!paragraphId || !text) {
                    this.showStatus('Please select a paragraph and enter comment text', 'error');
                    return;
                }
                
                try {
                    const response = await fetch('/api/add_comment/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            document_id: this.currentDocumentId,
                            paragraph_id: parseInt(paragraphId),
                            author: author,
                            text: text
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to add comment');
                    }
                    
                    const newComment = await response.json();
                    this.comments.push(newComment);
                    
                    // Clear form
                    document.getElementById('commentInput').value = '';
                    document.getElementById('paragraphSelect').value = '';
                    this.selectedParagraphId = null;
                    
                    // Remove selection
                    document.querySelectorAll('.paragraph.selected').forEach(el => {
                        el.classList.remove('selected');
                    });
                    
                    this.renderComments();
                    this.showStatus('Comment added successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error adding comment:', error);
                    this.showStatus('Error adding comment', 'error');
                }
            }
            
            async exportDocument() {
                if (!this.currentDocumentId) return;
                
                try {
                    const response = await fetch(`/api/export/${this.currentDocumentId}/`);
                    
                    if (!response.ok) {
                        throw new Error('Export failed');
                    }
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `updated_document.docx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    this.showStatus('Document exported successfully!', 'success');
                    
                } catch (error) {
                    console.error('Export error:', error);
                    this.showStatus('Error exporting document', 'error');
                }
            }
            
            showCommentForm() {
                document.getElementById('addCommentForm').style.display = 'block';
            }
            
            showExportButton() {
                document.getElementById('export-section').style.display = 'block';
            }
            
            showStatus(message, type) {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
                statusElement.classList.remove('hidden');
                
                setTimeout(() => {
                    statusElement.classList.add('hidden');
                }, 5000);
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new DocxCommentEditor();
        });
    </script>
</body>
</html>